(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{3961:function(e,t,n){Promise.resolve().then(n.bind(n,2314))},4129:function(e,t,n){"use strict";n.d(t,{O:function(){return r}});var o=n(6436),a=n(4504);if(!a.vc.SUPABASE_URL||!a.vc.SUPABASE_ANON_KEY)throw Error("Missing required Supabase configuration");let r=(0,o.eI)(a.vc.SUPABASE_URL,a.vc.SUPABASE_ANON_KEY)},4504:function(e,t,n){"use strict";n.d(t,{Ho:function(){return p},vc:function(){return _},aC:function(){return g}});var o=n(7440);let a=o.z.enum(["collector","business"]),r=o.z.enum(["active","used","expired"]),i=o.z.enum(["credit","coupon"]),s=o.z.object({latitude:o.z.number(),longitude:o.z.number()});o.z.object({id:o.z.string().uuid(),email:o.z.string().email(),name:o.z.string(),phone:o.z.string().optional(),role:a,location:s.optional(),createdAt:o.z.date(),updatedAt:o.z.date()}),o.z.object({id:o.z.string().uuid(),userId:o.z.string().uuid(),containerId:o.z.string(),timestamp:o.z.date(),location:s,batteryType:o.z.string(),certificateId:o.z.string().uuid().optional(),createdAt:o.z.date()}),o.z.object({id:o.z.string().uuid(),recyclingRecordId:o.z.string().uuid(),userId:o.z.string().uuid(),businessId:o.z.string().uuid().optional(),issueDate:o.z.date(),validUntil:o.z.date(),status:r,createdAt:o.z.date(),updatedAt:o.z.date()}),o.z.object({id:o.z.string().uuid(),userId:o.z.string().uuid(),type:i,amount:o.z.number(),shopifyProductId:o.z.string().optional(),expiryDate:o.z.date().optional(),status:r,createdAt:o.z.date(),updatedAt:o.z.date()});var c=n(8405),u=n(6193),l=n(4129);let d=(0,u.createContext)({session:null,user:null,loading:!0,error:null}),p=e=>{let{children:t}=e,[n,o]=(0,u.useState)(null),[a,r]=(0,u.useState)(null),[i,s]=(0,u.useState)(!0),[p,g]=(0,u.useState)(null);return(0,u.useEffect)(()=>{l.O.auth.getSession().then(e=>{var t;let{data:{session:n},error:a}=e;a&&(console.error("Error getting session:",a),g(a.message)),console.log("Initial session:",n),o(n),r(null!==(t=null==n?void 0:n.user)&&void 0!==t?t:null),s(!1)});let{data:{subscription:e}}=l.O.auth.onAuthStateChange(async(e,t)=>{var n;if(console.log("Auth state change event:",e),console.log("New session:",t),o(t),r(null!==(n=null==t?void 0:t.user)&&void 0!==n?n:null),s(!1),null==t?void 0:t.user){let{error:e}=await l.O.auth.getUser();e?(console.error("Error verifying user:",e),g(e.message)):g(null)}});return()=>e.unsubscribe()},[]),(0,c.jsx)(d.Provider,{value:{session:n,user:a,loading:i,error:p},children:t})},g=()=>{let e=(0,u.useContext)(d);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e};var h=n(4331);let _={SUPABASE_URL:h.env.NEXT_PUBLIC_SUPABASE_URL,SUPABASE_ANON_KEY:h.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}},2314:function(e,t,n){"use strict";n.r(t),n.d(t,{EcoCuponManager:function(){return P}});var o=n(8405),a=n(6193),r=n(4129);n(5887);var i=n(3297),s=n(7440),c=n(4331),u={SHOPIFY_API_KEY:c.env.NEXT_PUBLIC_SHOPIFY_API_KEY||"",SHOPIFY_API_SECRET:c.env.SHOPIFY_API_SECRET||"",SHOPIFY_ACCESS_TOKEN:c.env.SHOPIFY_ACCESS_TOKEN||"",SHOPIFY_SHOP_NAME:c.env.NEXT_PUBLIC_SHOPIFY_SHOP_NAME||""},l=s.z.object({code:s.z.string().min(3).max(50).regex(/^[A-Z0-9-_]+$/),discountType:s.z.enum(["percentage","fixed_amount"]),discountValue:s.z.number().positive().max(100),minPurchaseAmount:s.z.number().positive().optional(),maxDiscountAmount:s.z.number().positive().optional(),startDate:s.z.date(),expiryDate:s.z.date(),usageLimit:s.z.number().int().positive().optional(),userId:s.z.string().uuid()}),d=class e{static getInstance(){return e.instance||(e.instance=new e),e.instance}async createEcoCupon(e){try{let t=l.parse(e);if(t.expiryDate<=t.startDate)throw Error("La fecha de expiraci\xf3n debe ser posterior a la fecha de inicio");let n=new this.shopify.clients.Rest({session:new i.Session({id:"",shop:u.SHOPIFY_SHOP_NAME,state:"",isOnline:!0,accessToken:u.SHOPIFY_ACCESS_TOKEN})}),o=await n.post({path:"price_rules",data:{price_rule:{title:"EcoCupon - ".concat(t.code),target_type:"line_item",target_selection:"all",allocation_method:"across",value_type:"percentage"===t.discountType?"percentage":"fixed_amount",value:-t.discountValue,customer_selection:"all",starts_at:t.startDate.toISOString(),ends_at:t.expiryDate.toISOString(),usage_limit:t.usageLimit,prerequisite_subtotal_range:t.minPurchaseAmount?{greater_than_or_equal_to:t.minPurchaseAmount}:void 0}}}),{data:a,error:s}=await r.O.from("ecocupons").insert([{code:t.code,discount_type:t.discountType,discount_value:t.discountValue,min_purchase_amount:t.minPurchaseAmount,max_discount_amount:t.maxDiscountAmount,start_date:t.startDate.toISOString(),expiry_date:t.expiryDate.toISOString(),usage_limit:t.usageLimit,user_id:t.userId,shopify_price_rule_id:o.body.price_rule.id}]).select().single();if(s)throw s;return a}catch(e){throw console.error("Error creating EcoCupon:",e),e}}async validateEcoCupon(e){try{let t=e.trim().toUpperCase();if(!/^[A-Z0-9-_]+$/.test(t))return{valid:!1,message:"C\xf3digo inv\xe1lido"};let{data:n,error:o}=await r.O.from("ecocupons").select("*").eq("code",t).eq("status","active").single();if(o)throw o;if(!n)return{valid:!1,message:"Cup\xf3n no encontrado"};if(n.expiry_date&&new Date(n.expiry_date)<new Date)return await this.deactivateEcoCupon(n.id),{valid:!1,message:"Cup\xf3n expirado"};if(n.usage_limit&&n.times_used>=n.usage_limit)return await this.deactivateEcoCupon(n.id),{valid:!1,message:"Cup\xf3n alcanz\xf3 el l\xedmite de uso"};return{valid:!0,cupon:n}}catch(e){throw console.error("Error validating eco cupon:",e),e}}async deactivateEcoCupon(e){try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))throw Error("Invalid cupon ID format");let{data:t,error:n}=await r.O.from("ecocupons").update({status:"inactive"}).eq("id",e).select().single();if(n)throw n;if(t.shopify_price_rule_id){let e=new this.shopify.clients.Rest({session:new i.Session({id:"",shop:u.SHOPIFY_SHOP_NAME,state:"",isOnline:!0,accessToken:u.SHOPIFY_ACCESS_TOKEN})});await e.put({path:"price_rules/".concat(t.shopify_price_rule_id),data:{price_rule:{status:"disabled"}}})}return t}catch(e){throw console.error("Error deactivating eco cupon:",e),e}}async incrementCuponUsage(e){try{let t=e.trim().toUpperCase();if(!/^[A-Z0-9-_]+$/.test(t))throw Error("Invalid coupon code format");let{data:n,error:o}=await r.O.from("ecocupons").update({times_used:{increment:1}}).eq("code",t).select().single();if(o)throw o;return n.usage_limit&&n.times_used>=n.usage_limit&&await this.deactivateEcoCupon(n.id),n}catch(e){throw console.error("Error incrementing cupon usage:",e),e}}async getEcoCupons(e){try{let{data:t,error:n}=await r.O.from("ecocupons").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(n)throw n;return t}catch(e){throw console.error("Error getting EcoCupons:",e),e}}async getEcoCupon(e){try{let{data:t,error:n}=await r.O.from("ecocupons").select("*").eq("code",e).single();if(n)throw n;return t}catch(e){throw console.error("Error getting EcoCupon:",e),e}}async updateEcoCupon(e,t){try{let{data:n,error:o}=await r.O.from("ecocupons").update(t).eq("code",e).select().single();if(o)throw o;return n}catch(e){throw console.error("Error updating EcoCupon:",e),e}}async deleteEcoCupon(e){try{let{error:t}=await r.O.from("ecocupons").delete().eq("code",e);if(t)throw t}catch(e){throw console.error("Error deleting EcoCupon:",e),e}}constructor(){if(!u.SHOPIFY_API_KEY||!u.SHOPIFY_API_SECRET||!u.SHOPIFY_ACCESS_TOKEN)throw Error("Missing required Shopify configuration");this.shopify=(0,i.shopifyApi)({apiKey:u.SHOPIFY_API_KEY,apiSecretKey:u.SHOPIFY_API_SECRET,scopes:["write_discounts"],hostName:u.SHOPIFY_SHOP_NAME,isEmbeddedApp:!0,apiVersion:i.ApiVersion.January24})}},p=n(6972),g=n(6465),h=n(4971),_=n(3386),m=n(3342),E=n(5296),f=n(6267),v=n(5690),y=n(6305),C=n(1139),S=n(9667),x=n(8264),A=n(1145),w=n(4504);d.getInstance();let P=()=>{let{user:e,session:t}=(0,w.aC)(),[n,i]=(0,a.useState)([]),[s,c]=(0,a.useState)(!1),[u,l]=(0,a.useState)(!1),[d,P]=(0,a.useState)(""),[O,b]=(0,a.useState)({code:"",discountType:"percentage",discountValue:"",minPurchaseAmount:"",maxDiscountAmount:"",startDate:new Date,expiryDate:new Date,usageLimit:""});(0,a.useEffect)(()=>{t?(console.log("Loading cupons with session:",t),z()):(console.log("No session available"),P("Please sign in to manage cupons"))},[t]);let z=async()=>{try{l(!0),console.log("Fetching cupons...");let{data:e,error:t}=await r.O.from("eco_cupons").select("*").order("created_at",{ascending:!1});if(t)throw console.error("Error fetching cupons:",t),t;console.log("Cupons loaded:",e),i(e||[])}catch(e){console.error("Error in loadCupons:",e),P("Error al cargar cupones: "+(e.message||"Unknown error"))}finally{l(!1)}},I=async()=>{if(!t){P("Please sign in to create cupons");return}try{l(!0),P(""),console.log("Creating cupon with data:",O);let{data:t,error:n}=await r.O.from("eco_cupons").insert([{...O,user_id:null==e?void 0:e.id,status:"active"}]).select().single();if(n)throw console.error("Error creating cupon:",n),n;console.log("Cupon created successfully:",t),c(!1),await z()}catch(e){console.error("Error in handleSubmit:",e),P("Error al crear el cup\xf3n: "+(e.message||"Unknown error"))}finally{l(!1)}},j=async e=>{if(!t){P("Please sign in to deactivate cupons");return}try{l(!0),console.log("Deactivating cupon:",e);let{error:t}=await r.O.from("eco_cupons").update({status:"inactive"}).eq("id",e);if(t)throw console.error("Error deactivating cupon:",t),t;console.log("Cupon deactivated successfully"),await z()}catch(e){console.error("Error in handleDeactivate:",e),P("Error al desactivar el cup\xf3n: "+(e.message||"Unknown error"))}finally{l(!1)}};if(!t)return(0,o.jsx)(p.Z,{children:(0,o.jsx)(g.E,{children:(0,o.jsx)(h.jL,{tone:"warning",children:(0,o.jsx)("p",{children:"Please sign in to manage cupons"})})})});let D=n.map(e=>[e.code,"percentage"===e.discount_type?"".concat(e.discount_value,"%"):"$".concat(e.discount_value),e.min_purchase_amount?"$".concat(e.min_purchase_amount):"N/A",e.times_used||0,e.status,(0,o.jsx)(_.z,{disabled:"active"!==e.status||u,onClick:()=>j(e.id),children:"Desactivar"})]);return(0,o.jsxs)("div",{children:[d&&(0,o.jsx)(h.jL,{tone:"critical",onDismiss:()=>P(""),children:(0,o.jsx)("p",{children:d})}),(0,o.jsx)(p.Z,{children:(0,o.jsxs)(g.E,{children:[(0,o.jsxs)(m.g,{align:"space-between",children:[(0,o.jsx)(E.x,{as:"h2",variant:"headingLg",children:"Eco Cupones"}),(0,o.jsx)(_.z,{variant:"primary",onClick:()=>c(!0),disabled:u,children:"Crear Cup\xf3n"})]}),u?(0,o.jsx)("div",{className:"flex justify-center p-4",children:(0,o.jsx)(f.$,{accessibilityLabel:"Loading cupons",size:"large"})}):(0,o.jsx)(v.w,{columnContentTypes:["text","text","text","numeric","text","text"],headings:["C\xf3digo","Descuento","M\xednimo de compra","Usos","Estado","Acciones"],rows:D})]})}),(0,o.jsx)(y.u,{open:s,onClose:()=>c(!1),title:"Crear Eco Cup\xf3n",primaryAction:{content:"Crear",onAction:I,loading:u},secondaryActions:[{content:"Cancelar",onAction:()=>c(!1)}],children:(0,o.jsx)(y.u.Section,{children:(0,o.jsxs)(g.E,{children:[(0,o.jsx)(C.n,{label:"C\xf3digo",value:O.code,onChange:e=>b({...O,code:e}),autoComplete:"off",disabled:u}),(0,o.jsx)(S.P,{label:"Tipo de descuento",options:[{label:"Porcentaje",value:"percentage"},{label:"Monto fijo",value:"fixed_amount"}],value:O.discountType,onChange:e=>b({...O,discountType:e}),disabled:u}),(0,o.jsx)(C.n,{label:"Valor del descuento",value:O.discountValue,onChange:e=>b({...O,discountValue:e}),type:"number",autoComplete:"off",disabled:u}),(0,o.jsx)(C.n,{label:"Monto m\xednimo de compra",value:O.minPurchaseAmount,onChange:e=>b({...O,minPurchaseAmount:e}),type:"number",autoComplete:"off",disabled:u}),(0,o.jsx)(C.n,{label:"L\xedmite de uso",value:O.usageLimit,onChange:e=>b({...O,usageLimit:e}),type:"number",autoComplete:"off",disabled:u}),(0,o.jsxs)(x.x,{children:[(0,o.jsx)(E.x,{as:"p",variant:"bodyMd",children:"Fecha de inicio"}),(0,o.jsx)(A.M,{month:O.startDate.getMonth(),year:O.startDate.getFullYear(),onMonthChange:(e,t)=>{let n=new Date(O.startDate);n.setMonth(e),n.setFullYear(t),b({...O,startDate:n})},selected:{start:O.startDate,end:O.startDate},onChange:e=>{e.start&&b({...O,startDate:e.start})}})]}),(0,o.jsxs)(x.x,{children:[(0,o.jsx)(E.x,{as:"p",variant:"bodyMd",children:"Fecha de expiraci\xf3n"}),(0,o.jsx)(A.M,{month:O.expiryDate.getMonth(),year:O.expiryDate.getFullYear(),onMonthChange:(e,t)=>{let n=new Date(O.expiryDate);n.setMonth(e),n.setFullYear(t),b({...O,expiryDate:n})},selected:{start:O.expiryDate,end:O.expiryDate},onChange:e=>{e.start&&b({...O,expiryDate:e.start})}})]})]})})})]})}}},function(e){e.O(0,[207,292,85,370,228,744],function(){return e(e.s=3961)}),_N_E=e.O()}]);